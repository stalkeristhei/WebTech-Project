<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mark Attendance - Smart Attendance System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="./config.js"></script>
    <style>
        :root {
            --bg-primary: #f8f9fa;
            --text-primary: #212529;
            --accent-primary: #2a9d8f;
            --accent-dark: #21867a;
            --card-bg: #ffffff;
            --success: #28a745;
            --error: #e63946;
            --shadow-light: 0 6px 20px rgba(0, 0, 0, 0.07);
        }

        /* üåÜ Background added */
        body {
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            margin: 0;
            background: linear-gradient(to bottom right, #e0f2f1, #ffffff);
            background-image: url('assets/bg-pattern.svg'); /* optional image overlay */
            background-repeat: no-repeat;
            background-size: cover;
            background-attachment: fixed;
        }

        .navbar {
            background: var(--card-bg);
            box-shadow: var(--shadow-light);
            padding: 1rem 2rem;
        }

        .nav-container {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand { font-size: 1.25rem; font-weight: 700; color: var(--accent-dark); }
        .nav-brand span {
            background-color: #e9ecef;
            color: var(--accent-dark);
            padding: 0.25rem 0.75rem;
            border-radius: 8px;
            font-size: 1rem;
            margin-left: 0.5rem;
        }

        .nav-link {
            background: transparent; color: var(--accent-primary);
            border: 1px solid var(--accent-primary);
            padding: 0.5rem 1.25rem; border-radius: 50px;
            font-weight: 600; cursor: pointer; text-decoration: none;
            transition: all 0.3s ease;
        }

        .nav-link:hover { background: var(--accent-primary); color: white; }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        .header { text-align: center; margin-bottom: 2rem; }
        .header h1 { font-size: 2.5rem; font-weight: 700; color: var(--accent-dark); }

        .date-selector {
            background: var(--card-bg);
            padding: 1rem 1.5rem;
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }

        .date-selector label { font-weight: 600; }

        #attendanceDate {
            font-size: 1rem;
            padding: 0.5rem 1rem;
            border: 1px solid #ced4da;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .student-list-container {
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            overflow: hidden;
            min-height: 150px;
        }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem 1.5rem; text-align: left; border-bottom: 1px solid #e9ecef; }
        th { background-color: #f8f9fa; font-weight: 600; color: #495057; }
        tr:last-child td { border-bottom: none; }

        .present-btn {
            background-color: var(--accent-primary);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .present-btn:hover { background-color: var(--accent-dark); transform: scale(1.05); }

        .present-btn:disabled {
            background-color: var(--success);
            cursor: default;
            transform: none;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">üìù Daily Roll Call<span id="nav-class-code">...</span></div>
            <a href="tindex.html" id="back-link" class="nav-link">‚Üê Back to Hub</a>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>Mark Student Attendance</h1>
        </div>
        <div class="date-selector">
            <label for="attendanceDate">Attendance Date:</label>
            <input type="date" id="attendanceDate">
        </div>
        <div class="student-list-container">
            <table>
                <thead>
                    <tr>
                        <th>Roll No.</th>
                        <th>Name</th>
                        <th style="text-align: center;">Action</th>
                    </tr>
                </thead>
                <tbody id="studentListBody">
                    <tr><td colspan="3" style="text-align:center; padding: 3rem; color: #6c757d;">Initializing...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { getSupabase } from './js/supabase-init.js';
        import { showToast } from './js/toast.js';

        const studentListBody = document.getElementById('studentListBody');
        const attendanceDateInput = document.getElementById('attendanceDate');
        
        const activeClassCode = localStorage.getItem('activeClassCode');
        const activeClassId = localStorage.getItem('activeClassId');
        let classRoster = [];
        let markedStudents = new Set();

        document.addEventListener('DOMContentLoaded', async () => {
            if (!activeClassCode || !activeClassId) {
                alert("No active class selected. Redirecting.");
                window.location.href = 'manage-class.html';
                return;
            }

            document.getElementById('nav-class-code').textContent = activeClassCode;
            document.getElementById('back-link').href = `tindex.html?classCode=${activeClassCode}`;
            attendanceDateInput.value = new Date().toISOString().split('T')[0];
            
            attendanceDateInput.addEventListener('change', refreshAttendanceStatus);
            studentListBody.addEventListener('click', handleMarkPresentClick);

            try {
                const supabase = await getSupabase();
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) throw new Error("You are not logged in. Redirecting to login page.");
                await fetchClassRoster();
            } catch(error) {
                showToast(error.message, 'error');
                studentListBody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding: 3rem; color: var(--error);">${error.message}</td></tr>`;
                setTimeout(() => window.location.href = 'login.html', 2000);
            }
        });

        async function fetchClassRoster() {
            studentListBody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding: 3rem; color: #6c757d;">Loading roster...</td></tr>`;
            try {
                const supabase = await getSupabase();
                const { data: classData, error: classError } = await supabase
                    .from('classes')
                    .select('id')
                    .eq('class_code', activeClassCode)
                    .single();
                
                if (classError) throw new Error(`Could not find class. Your RLS policy may be blocking access.`);
                
                const { data, error } = await supabase
                    .from('enrollments')
                    .select('students(roll_number, full_name)')
                    .eq('class_id', classData.id)
                    .order('roll_number', { referencedTable: 'students', ascending: true });

                if (error) throw error;
                
                classRoster = data.filter(e => e.students).map(e => e.students);
                await refreshAttendanceStatus();
            } catch (error) {
                console.error('Error fetching roster:', error);
                showToast(`Error: ${error.message}`, 'error');
                studentListBody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding: 3rem; color: var(--error);">Could not load roster.</td></tr>`;
            }
        }

        async function refreshAttendanceStatus() {
            try {
                const supabase = await getSupabase();
                const selectedDate = attendanceDateInput.value;
                const { data, error } = await supabase
                    .from('student_log')
                    .select('"Roll Number"')
                    .eq('Date', selectedDate)
                    .eq('Status', 'Present')
                    .eq('class_id', activeClassId); // Filter by class to avoid showing students marked in other classes
                
                if (error) throw error;
                markedStudents = new Set(data.map(s => s['Roll Number']));
                renderStudentList();
            } catch (error) {
                showToast(`Error checking status: ${error.message}`, 'error');
            }
        }

        function renderStudentList() {
            studentListBody.innerHTML = '';
            if (classRoster.length === 0) {
                studentListBody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding: 3rem; color: #6c757d;">No students have joined this class yet.</td></tr>`;
                return;
            }

            classRoster.forEach(student => {
                const isMarked = markedStudents.has(student.roll_number);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${student.roll_number}</strong></td>
                    <td>${student.full_name}</td>
                    <td style="text-align: center;">
                        <button class="present-btn" data-roll="${student.roll_number}" data-name="${student.full_name}" ${isMarked ? 'disabled' : ''}>
                            ${isMarked ? '‚úÖ Marked' : 'Mark Present'}
                        </button>
                    </td>
                `;
                studentListBody.appendChild(row);
            });
        }
        
        async function handleMarkPresentClick(e) {
            const button = e.target.closest('.present-btn');
            if (!button || button.disabled) return;
            
            button.disabled = true;
            button.textContent = 'Marking...';

            const roll = button.dataset.roll;
            const name = button.dataset.name;
            const selectedDate = attendanceDateInput.value;

            try {
                const supabase = await getSupabase();
                const { error } = await supabase.from('student_log').insert({
                    'Roll Number': roll,
                    'Name': name,
                    'Date': selectedDate,
                    'Status': 'Present',
                    'class_id': activeClassId // Add class_id to track which class this attendance is for
                });

                if (error) throw error;

                showToast(`${name} marked present!`, 'success');
                markedStudents.add(roll);
                button.textContent = '‚úÖ Marked';
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
                button.disabled = false;
                button.textContent = 'Mark Present';
            }
        }
    </script>
</body>
</html>
